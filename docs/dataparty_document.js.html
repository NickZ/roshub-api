<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>dataparty/document.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CloudParty.html">CloudParty</a><ul class='methods'><li data-type='method'><a href="CloudParty.html#call">call</a></li><li data-type='method'><a href="CloudParty.html#decrypt">decrypt</a></li><li data-type='method'><a href="CloudParty.html#encrypt">encrypt</a></li><li data-type='method'><a href="CloudParty.html#hasActor">hasActor</a></li><li data-type='method'><a href="CloudParty.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="CloudParty.html#loadActor">loadActor</a></li><li data-type='method'><a href="CloudParty.html#loadIdentity">loadIdentity</a></li><li data-type='method'><a href="CloudParty.html#socket">socket</a></li><li data-type='method'><a href="CloudParty.html#start">start</a></li></ul></li><li><a href="DataModel.html">DataModel</a><ul class='methods'><li data-type='method'><a href="DataModel.html#addFactory">addFactory</a></li><li data-type='method'><a href="DataModel.html#getDocument">getDocument</a></li><li data-type='method'><a href="DataModel.html#getFactories">getFactories</a></li><li data-type='method'><a href="DataModel.html#getFactory">getFactory</a></li><li data-type='method'><a href="DataModel.html#getTypes">getTypes</a></li><li data-type='method'><a href="DataModel.html#hydrate">hydrate</a></li><li data-type='method'><a href="DataModel.html#validate">validate</a></li></ul></li><li><a href="LocalStorageConfig.html">LocalStorageConfig</a></li><li><a href="MemoryConfig.html">MemoryConfig</a></li><li><a href="module-roshub.Api.html">Api</a><ul class='methods'><li data-type='method'><a href="module-roshub.Api.html#getLegalAgreements">getLegalAgreements</a></li></ul></li><li><a href="module-roshub.DataParty.html">DataParty</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.html#call">call</a></li><li data-type='method'><a href="module-roshub.DataParty.html#create">create</a></li><li data-type='method'><a href="module-roshub.DataParty.html#createDocument">createDocument</a></li><li data-type='method'><a href="module-roshub.DataParty.html#find">find</a></li><li data-type='method'><a href="module-roshub.DataParty.html#remove">remove</a></li><li data-type='method'><a href="module-roshub.DataParty.html#socket">socket</a></li><li data-type='method'><a href="module-roshub.DataParty.html#start">start</a></li><li data-type='method'><a href="module-roshub.DataParty.html#types">types</a></li><li data-type='method'><a href="module-roshub.DataParty.html#update">update</a></li></ul></li><li><a href="module-roshub.DataParty.Document.html">Document</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.Document.html#acl">acl</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#getData">getData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#grantAccess">grantAccess</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#mergeData">mergeData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#pull">pull</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#save">save</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#setData">setData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#unwatch">unwatch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watch">watch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watchField">watchField</a></li></ul></li><li><a href="module-roshub_Types.Acl.html">Acl</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Acl.html#getPermissionsByField">getPermissionsByField</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#resource">resource</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#setPermissionsByField">setPermissionsByField</a></li></ul></li><li><a href="module-roshub_Types.BillingAccount.html">BillingAccount</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreed">hasAgreed</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToMarketing">hasAgreedToMarketing</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToPrivacy">hasAgreedToPrivacy</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToTos">hasAgreedToTos</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasPlan">hasPlan</a></li></ul></li><li><a href="module-roshub_Types.Code.html">Code</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Code.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Code.html#addToDevice">addToDevice</a></li></ul></li><li><a href="module-roshub_Types.CodeStatus.html">CodeStatus</a></li><li><a href="module-roshub_Types.ConsoleLog.html">ConsoleLog</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.ConsoleLog.html#.create">create</a></li></ul></li><li><a href="module-roshub_Types.Device.html">Device</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Device.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#addIdentity">addIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#attachBlePeer">attachBlePeer</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#bleRun">bleRun</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#config">config</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#enroll">enroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#getCodeDocumentList">getCodeDocumentList</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#info">info</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#removeCode">removeCode</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#status">status</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topic">topic</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topics">topics</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#unenroll">unenroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiConnect">wifiConnect</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiScan">wifiScan</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiState">wifiState</a></li></ul></li><li><a href="module-roshub_Types.DeviceConfig.html">DeviceConfig</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#addCode">addCode</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#getCodeList">getCodeList</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#module">module</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#updateModule">updateModule</a></li></ul></li><li><a href="module-roshub_Types.DeviceInfo.html">DeviceInfo</a></li><li><a href="module-roshub_Types.DeviceStatus.html">DeviceStatus</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#getProgress">getProgress</a></li><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#module">module</a></li></ul></li><li><a href="module-roshub_Types.Identity.html">Identity</a></li><li><a href="module-roshub_Types.Org.html">Org</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Org.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.Org.html#teams">teams</a></li></ul></li><li><a href="module-roshub_Types.Topic.html">Topic</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Topic.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Topic.html#instance">instance</a></li></ul></li><li><a href="module-roshub_Types.User.html">User</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.User.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.User.html#codes">codes</a></li><li data-type='method'><a href="module-roshub_Types.User.html#devices">devices</a></li><li data-type='method'><a href="module-roshub_Types.User.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.User.html#orgs">orgs</a></li><li data-type='method'><a href="module-roshub_Types.User.html#teams">teams</a></li></ul></li><li><a href="NconfConfig.html">NconfConfig</a></li></ul><h3>Modules</h3><ul><li><a href="module-roshub.html">roshub</a></li><li><a href="module-roshub_Types.html">roshub/Types</a></li></ul><h3>Events</h3><ul><li><a href="module-roshub.DataParty.Document.html#event:change">change</a></li><li><a href="module-roshub.DataParty.Document.html#event:create">create</a></li><li><a href="module-roshub.DataParty.Document.html#event:field">field</a></li><li><a href="module-roshub.DataParty.Document.html#event:value">value</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-roshub.Config.html">Config</a></li></ul><h3>Global</h3><ul><li><a href="global.html#model">model</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">dataparty/document.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const reach = require('../reach')
const debug = require('debug')('roshub.dataparty.document')
const EventEmitter = require('last-eventemitter')

/**
 * Represents a cached document with cloud change notifications
 * @class
 * @interface
 * @alias module:roshub.DataParty.Document
 * @param {object}    options
 * @param {DataParty} options.party
 * @param {string}    options.id
 * @param {string}    options.type
 * @param {object}    options.data
 * @param {boolean}   options.followcache
 */
class Document extends EventEmitter {
  constructor({party, type, id, data, followcache}){
    super()
    this.party = party
    this.watchSub = undefined
    this.autopull = true     //! If we detect a cloud change should we copy into the local cache?
    this.flushcache = true   //! If we detect a cloud change should we flush the local cache?
    this.followcache = followcache !== undefined ? followcache: true  //! Watch document for local changes
    this.watchedFields = {}
    this.watchedFilters = {}

    debug('document', type, id, data)

    this._data = {
      ...data,
      $meta: {id: id, type: type},
    }

    this.party.cache.on(this.idString, this._handleCacheEvent.bind(this))
  }


  _handleCacheEvent(event){

    debug('cache event', this.idString, event)
    const newMsg = this.party.cache.findById(this.type, this.id)
    const oldMsg = Object.assign({}, this.getData())

    debug('new message', newMsg)

    switch (event.event){
      case 'remove':
      case 'update':
      case 'create':

        if(this.followcache){ 
          this._data = newMsg 

          /**
           * Document value Event - This event is triggered after a change has been 
           * applied to the backing cache of `Document.data`. Only fired when `Document.followcache` 
           * is true.
           * @event module:roshub.DataParty.Document#value
           * @type {Document}
           */
          this.emit('value', this)
        }

        /**
         * Document modified Event - This event is triggered after a change has been 
         * applied to the backing cache of `Document.data`. If `Document.followcache` 
         * is true the document `doc` has also accepted the change.
         * 
         * @event module:roshub.DataParty.Document#remove
         * @event module:roshub.DataParty.Document#update
         * @event module:roshub.DataParty.Document#create
         * @type {object}
         * @property  {module:roshub.DataParty.Document}  doc the changed document
         * @property  {object}  new the new document data
         * @property  {object}  old the old document data
         */
        this.emit(event.event, {new: newMsg, old: oldMsg, doc: this})

        if(this.watchedFields &amp;&amp; Object.keys(this.watchedFields).length > 0){

          // Emit field level changes

          for(const field in this.watchedFields){
            const expected = this.watchedFields[field]
      
            const oldVal = JSON.stringify(reach(oldMsg, field))
            const newVal = JSON.stringify(reach(newMsg, field))
      
            if(oldVal !== newVal){

              // TODO: Should we do both raising and falling edge detection? Should it be configurable?
              if( (typeof expected == 'object' &amp;&amp; newVal != JSON.stringify(expected.$eq))) /* &amp;&amp;
                  (typeof expected == 'object' &amp;&amp; oldVal != JSON.stringify(expected.$eq))) */
              { continue }


              /**
               * Field change event. This is emitted as `field.[FIELD_PATH]`
               * @event module:roshub.DataParty.Document#field
               * @type  {object}
               * @property  doc   The changed document
               * @property  field The changed FIELDPATH 
               * @property  old   The old field value
               * @property  new   The new field value
               * @property  expected  The expected field value
               */
              this.emit('field.'+field, {
                expected,
                doc: doc,
                field: field,
                old: reach(oldMsg, field),
                new: reach(newMsg, field)
              })
            }
          }
        }
        break
      default:
        debug('unexpected event', event, this)
        break
    }
  }



  _handleWatchMsg(message){
    if(!this.watchSub){return}
    debug(`document changed ${this.watchSub.name} `, message)

    if (this.autopull){ this.pull.bind(this)(this.flushcache) }

    /**
     * Document change Event - This is event is triggered when a document has been
     * modified on the `CloudParty` service
     * @event module:roshub.DataParty.Document#change
     * @type {object}
     */
    this.emit('change', message)
  }


  /**
   * Get this document's Acl
   * @method
   * @returns {Acl}
   */
  async acl(){
    if (this.type == 'acl'){
      return this
    }

    const aclDocumentList = await this.party.find()
      .type('acl')
      .where('resource.id').equals(this.id)
      .where('resource.type').equals(this.type)
      .exec()

    if(aclDocumentList.length > 0) {
      debug('found ACL for document -', this.idString)
      return aclDocumentList[0]
    }

    debug('creating acl')

    const rawAcl = (await this.party.create('acl', {
      resource: {
        id: this.id,
        type: this.type
      }
    }))[0]

    debug('created acl', rawAcl)

    const aclDoc = (await this.party.find()
      .type(reach(rawAcl, '$meta.type') || rawAcl.type)
      .id(reach(rawAcl, '$meta.id') || rawAcl.id)
      .exec())[0]

    debug('created ACL for document -', this.idString, aclDoc.data)

    return aclDoc
  }

  /**
   * Allow access to this document or a subfield
   * @methed
   * @param {string}  action  CRUFL operation
   * @param {IdObj}   actor   Actor object
   * @param {string}  field   Document subfield
   * @param {string}  allowed Allow/deny named `actor` access
   */
  async grantAccess(action, actor, field = '', allowed = true) {
    const aclDocument = await this.acl()
    debug('granting access to document -', this.idString, 'via acl - ', aclDocument.data)
    return aclDocument.setPermissionsByField(action, actor, field, allowed)
  }

  /**
   * Document mongo-id
   * @type {string}
   */
  get id(){ return reach(this._data, '$meta.id') }

  /**
   * Document type string
   * @type {string}
   */
  get type(){ return reach(this._data, '$meta.type') }

  /**
   * Document version string
   * @type {string}
   */
  get version(){ return reach(this._data, '$meta.version') }

  /**
   * Document owner as an IdObj
   * @type {IdObj}  
   */
  get owner(){
    return {
      id: reach(this.data, 'owner.id'),
      type: reach(this.data, 'owner.type')
    }
  }

  /**
   * @typedef {Object} IdObj
   * @property {string} id    &lt;mongo-id>
   * @property {string} type  Document type
   */

  /**
   * Document id string in format `&lt;type>:&lt;mongo-id>`
   * @type {IdObj}  
   */
  get idObj(){
    return {
      id: this.id,
      type: this.type
    }
  }

  /**
   * Document id string in format `&lt;type>:&lt;mongo-id>`
   * @type {sting}
   */
  get idString() { return this.type + ':' + this.id }

  /**
   * @method
   */
  getData(){ return this._data }

  /**
   * entire document
   * @type {object}
   */
  get data(){ return this._data }

  /**
   * document data with no library added fields
   * @type {object}
   */
  get cleanData(){
    const {$meta, ...obj} = this._data
    return obj
  }

  /**
   * Merge fields into document
   * @method
   * @param {object}  input
   * @returns {object}
   */
  async mergeData(input){
    return this.setData(Object.assign({}, this.data, input))
  }

  /**
   * Set entire document
   * @method
   * @param {object}  input
   * @returns {object}
   */
  async setData(input){
    let valid = await this.party.model.validate(this.type, input)
    this._data = valid
  }

  /**
   * Download document changes from remote party
   * @method
   * @param {boolean} flushcache  Update local cache as well
   */
  async pull (flushcache) {

    // debug('this is :', this)

    debug('pulling', this.idString)

    if (!this.type){
      throw new Error('type undefined')
    }

    debug('pull', this.data)
    const typeCache = '' + this.type
    if (flushcache){
      this.party.cache.remove(this.type, this.id)
    }

    debug('pull type -', this.type)

    return this.party.find()
      .type(typeCache)
      .id(this.id)
      .exec()
      .then(docs => {
        this._data = docs[0].data

        debug('pull found', docs)

        return this
      })
  }

  /**
   * Saves document changes to remote party
   * @method
   */
  async save(){
    const value = Object.assign({}, this.data)

    delete value.$meta.version
    delete value.__v

    await this.setData(value)
    await this.party.update(value)
    await this.pull()
  }

  /**
   * Watches document for remote changes. 
   * @method
   * @param {boolean} autopull 
   * @param {boolean} flushcache 
   * @param {function=}  cb    Optional Change event callback function
   * @fires module:roshub.DataParty.Document#change
   */
  async watch(autopull, flushcache, cb){

    if(cb){ this.on('change', cb) }

    if([true,false].indexOf(autopull) &lt; 0 &amp;&amp; [true,false].indexOf(this.autopull) &lt; 0){ this.autopull = true }
    if([true,false].indexOf(flushcache) &lt; 0 &amp;&amp; [true,false].indexOf(this.flushcache) &lt; 0){ this.flushcache = true }
    if([true,false].indexOf(autopull) > -1){ this.autopull = autopull }
    if([true,false].indexOf(flushcache) > -1){ this.flushcache = flushcache }

    if (this.watchSub){ return }

    const socket = await this.party.socket()
    const ros = socket.ros
    const watchPath = '/dataparty/document/' + this.type + '/' + this.id

    debug('watch document', watchPath)

    this.watchSub = new this.party.ROSLIB.Topic({
      ros: ros,
      name: watchPath,
      messageType: 'dataparty/DocumentChange'
    })

    this.watchSub.subscribe(this._handleWatchMsg.bind(this))
  }

  /**
   * Stop watching for remote document changes
   * @param {function=}  cb    Optional Change event callback function
   */
  async unwatch(cb){
    if(cb){ this.off('change', cb) }

    this.autopull = undefined
    this.flushcache = undefined

    if(!this.watchSub){ return }

    this.watchSub.unsubscribe(this._handleWatchMsg.bind(this))
    this.watchSub = undefined
  }

  /**
   * Watch a field for changes. If `value` is supplied watches
   * for field and `value` to match.
   * 
   * @param {string}  field   Field path to watch for changes
   * @param {*=}      value   Match value
   * @param {function}  cb    Callback function
   * @fires module:roshub.DataParty.Document#field
   */
  async watchField(field, value, cb){
    this.watchedFields[field] = (value == undefined) ? true : {'$eq': value}

    if(cb){ this.on('field.'+field, cb) }
    if(!this.watchSub){ return this.watch() }
  }

  async unwatchField(field, cb){
    this.watchedFields[field] = undefined
    delete this.watchedFields[field]

    if(cb){ this.off('field.'+field, cb) }
  }

  static async create(party, data){

    debug('creating document ', data.type, data.id)

    const rawDocument = await party.create(data.type, data)
    return party.find()
      .type(rawDocument.type)
      .id(rawDocument.id)
      .exec()
  }

  async remove(){
    debug('removing document ', this.data.type, this.data.id)

    return this.party.remove(this.data)
  }
}

module.exports = Document
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Sep 06 2019 14:07:23 GMT-0700 (PDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
