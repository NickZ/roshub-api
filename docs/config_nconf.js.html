<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>config/nconf.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CloudParty.html">CloudParty</a><ul class='methods'><li data-type='method'><a href="CloudParty.html#call">call</a></li><li data-type='method'><a href="CloudParty.html#decrypt">decrypt</a></li><li data-type='method'><a href="CloudParty.html#encrypt">encrypt</a></li><li data-type='method'><a href="CloudParty.html#hasActor">hasActor</a></li><li data-type='method'><a href="CloudParty.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="CloudParty.html#loadActor">loadActor</a></li><li data-type='method'><a href="CloudParty.html#loadIdentity">loadIdentity</a></li><li data-type='method'><a href="CloudParty.html#socket">socket</a></li><li data-type='method'><a href="CloudParty.html#start">start</a></li></ul></li><li><a href="DataModel.html">DataModel</a><ul class='methods'><li data-type='method'><a href="DataModel.html#addFactory">addFactory</a></li><li data-type='method'><a href="DataModel.html#getDocument">getDocument</a></li><li data-type='method'><a href="DataModel.html#getFactories">getFactories</a></li><li data-type='method'><a href="DataModel.html#getFactory">getFactory</a></li><li data-type='method'><a href="DataModel.html#getTypes">getTypes</a></li><li data-type='method'><a href="DataModel.html#hydrate">hydrate</a></li><li data-type='method'><a href="DataModel.html#validate">validate</a></li></ul></li><li><a href="LocalStorageConfig.html">LocalStorageConfig</a></li><li><a href="MemoryConfig.html">MemoryConfig</a></li><li><a href="module-roshub.Api.html">Api</a><ul class='methods'><li data-type='method'><a href="module-roshub.Api.html#getLegalAgreements">getLegalAgreements</a></li></ul></li><li><a href="module-roshub.DataParty.html">DataParty</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.html#call">call</a></li><li data-type='method'><a href="module-roshub.DataParty.html#create">create</a></li><li data-type='method'><a href="module-roshub.DataParty.html#createDocument">createDocument</a></li><li data-type='method'><a href="module-roshub.DataParty.html#find">find</a></li><li data-type='method'><a href="module-roshub.DataParty.html#remove">remove</a></li><li data-type='method'><a href="module-roshub.DataParty.html#socket">socket</a></li><li data-type='method'><a href="module-roshub.DataParty.html#start">start</a></li><li data-type='method'><a href="module-roshub.DataParty.html#types">types</a></li><li data-type='method'><a href="module-roshub.DataParty.html#update">update</a></li></ul></li><li><a href="module-roshub.DataParty.Document.html">Document</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.Document.html#acl">acl</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#getData">getData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#grantAccess">grantAccess</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#mergeData">mergeData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#pull">pull</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#save">save</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#setData">setData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#unwatch">unwatch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watch">watch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watchField">watchField</a></li></ul></li><li><a href="module-roshub_Types.Acl.html">Acl</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Acl.html#getPermissionsByField">getPermissionsByField</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#resource">resource</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#setPermissionsByField">setPermissionsByField</a></li></ul></li><li><a href="module-roshub_Types.BillingAccount.html">BillingAccount</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreed">hasAgreed</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToMarketing">hasAgreedToMarketing</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToPrivacy">hasAgreedToPrivacy</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToTos">hasAgreedToTos</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasPlan">hasPlan</a></li></ul></li><li><a href="module-roshub_Types.Code.html">Code</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Code.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Code.html#addToDevice">addToDevice</a></li></ul></li><li><a href="module-roshub_Types.CodeStatus.html">CodeStatus</a></li><li><a href="module-roshub_Types.ConsoleLog.html">ConsoleLog</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.ConsoleLog.html#.create">create</a></li></ul></li><li><a href="module-roshub_Types.Device.html">Device</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Device.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#addIdentity">addIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#attachBlePeer">attachBlePeer</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#bleRun">bleRun</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#config">config</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#enroll">enroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#getCodeDocumentList">getCodeDocumentList</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#info">info</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#removeCode">removeCode</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#status">status</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topic">topic</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topics">topics</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#unenroll">unenroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiConnect">wifiConnect</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiScan">wifiScan</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiState">wifiState</a></li></ul></li><li><a href="module-roshub_Types.DeviceConfig.html">DeviceConfig</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#addCode">addCode</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#getCodeList">getCodeList</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#module">module</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#updateModule">updateModule</a></li></ul></li><li><a href="module-roshub_Types.DeviceInfo.html">DeviceInfo</a></li><li><a href="module-roshub_Types.DeviceStatus.html">DeviceStatus</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#getProgress">getProgress</a></li><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#module">module</a></li></ul></li><li><a href="module-roshub_Types.Identity.html">Identity</a></li><li><a href="module-roshub_Types.Org.html">Org</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Org.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.Org.html#teams">teams</a></li></ul></li><li><a href="module-roshub_Types.Topic.html">Topic</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Topic.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Topic.html#instance">instance</a></li></ul></li><li><a href="module-roshub_Types.User.html">User</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.User.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.User.html#codes">codes</a></li><li data-type='method'><a href="module-roshub_Types.User.html#devices">devices</a></li><li data-type='method'><a href="module-roshub_Types.User.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.User.html#orgs">orgs</a></li><li data-type='method'><a href="module-roshub_Types.User.html#teams">teams</a></li></ul></li><li><a href="NconfConfig.html">NconfConfig</a></li></ul><h3>Modules</h3><ul><li><a href="module-roshub.html">roshub</a></li><li><a href="module-roshub_Types.html">roshub/Types</a></li></ul><h3>Events</h3><ul><li><a href="module-roshub.DataParty.Document.html#event:change">change</a></li><li><a href="module-roshub.DataParty.Document.html#event:create">create</a></li><li><a href="module-roshub.DataParty.Document.html#event:field">field</a></li><li><a href="module-roshub.DataParty.Document.html#event:value">value</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-roshub.Config.html">Config</a></li></ul><h3>Global</h3><ul><li><a href="global.html#model">model</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">config/nconf.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const fs = require('fs')
const os = require('os')
const Path = require('path')
const nconf = require('nconf')
const touch = require('touch')
const mkdirp = require('mkdirp')
const sanitize = require('sanitize-filename')

const logger = require('debug')('roshub-api.config.nconf');

var BASE_PATH = process.env.SNAP_COMMON || ((process.env.HOME) ? (process.env.HOME + '/.roshub-api') : '.' )

/**
 * @class
 * @implements {Config}
 */
class NconfConfig {

  constructor(defaults, whitelist){
    this.whitelist = whitelist || []
    defaults = defaults || {}
    this.basePath = defaults.basePath || BASE_PATH
    this.defaults = defaults || {}
    this.defaults.logicalSeparator = '.'
    this.started=false
  }

  start () {
    if(this.started){ return Promise.resolve(this) }

    this.touchDir('')
    let file_name = 'config.json'
    nconf.argv()
    const config_file = nconf.get('config')
    if (config_file){
      const file_path = Path.parse(config_file)
      file_name = file_path.base
      if (!Path.isAbsolute(config_file)){
        this.basePath = process.cwd() + '/' + file_path.dir
      } else {
        this.basePath = file_path.dir
      }
    }
    nconf.file({
      file: file_name,
      dir: this.basePath,
      search: true,
      logicalSeparator: '.', 
    })
    nconf.env({
      logicalSeparator: '.', 
      whitelist: this.whitelist,
    })

    nconf.load()
    logger(`config ready: ${this.basePath}/${file_name}`)
    this.started = true
    return Promise.resolve(this)
  }

  clear () {
    logger('clear')
    return Promise((resolve,reject)=>{
      logger('clearing')
      nconf.set(null, {})

      nconf.save((err)=>{
        if(err){ return reject(err) }

        return resolve()
      })
    })
  }

  readAll(){
    logger('read all')
    return nconf.get();
  }

  read(key){
    logger('reading key: ' + key)
    let val = nconf.get(key)

    return val
  }

  async write(key, data){
    return new Promise((resolve,reject)=>{
      logger('write key: ' + key)
      if(!nconf.set(key, data)){
        return reject()
      }

      resolve(this.save())
    })
  }


  exists(key){
    return (read(key) !== undefined)
  }

  async save(){
    logger('saving')
    return new Promise((resolve,reject)=>{
      nconf.save((err)=>{
        if(err){logger(err); return reject(err)}

        logger('saved')
        resolve()
      })
    })
  }

  fileExists(path){
    var realPath = this.basePath+"/" + Path.dirname(path) + "/" + sanitize(Path.basename(path))

    return fs.existsSync(realPath)
  }

  filePath(path){
    return this.basePath+"/" + Path.dirname(path) + '/'+ sanitize(Path.basename(path))
  }

  /*
  * @returns Promise(data)
  */
  async readFile(path){
    return new Promise((resolve,reject)=>{

      const realPath = this.basePath+"/" + Path.dirname(path) + "/" + sanitize(Path.basename(path))

      logger("Reading from file: " + realPath)
      fs.readFile(realPath, 'utf8', (err,data)=>{
        if(err){
          return reject(err)
        }

        resolve(data)
      })

    })
}

async linkFiles(existingPath, newPath){
  return new Promise((resolve, reject) => {
    const basedNewPath = Path.join(this.basePath, newPath)
    const basedExistingPath = Path.join(this.basePath, existingPath)

    logger(`linking '${basedExistingPath} -> ${basedNewPath}'`)
    fs.symlink(basedExistingPath, basedNewPath, (error) => {
      if (error) {
        logger(`failed to link '${basedExistingPath} -> ${basedNewPath}':`, error)
        return reject(error)
      }

      logger(`linked '${basedExistingPath} -> ${basedNewPath}'`)
      // resolve to adjusted path on success
      resolve(basedNewPath)
    })
  })
}

  async touchDir (path) {
    return new Promise((resolve, reject) => {
      const basedPath = Path.join(this.basePath, path)
      logger('touching', basedPath)
      mkdirp(basedPath, (error) => {
        if (error) {
          logger(`failed to mkdirp '${basedPath}':`, error)
          return reject(error)
        }

        logger('touched', basedPath)
        // resolve to adjusted path on success
        resolve(basedPath)
      })
    })
  }
}

module.exports = NconfConfig</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Sep 06 2019 14:07:23 GMT-0700 (PDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
