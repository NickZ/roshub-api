<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>dataparty/cloud-party.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CloudParty.html">CloudParty</a><ul class='methods'><li data-type='method'><a href="CloudParty.html#call">call</a></li><li data-type='method'><a href="CloudParty.html#decrypt">decrypt</a></li><li data-type='method'><a href="CloudParty.html#encrypt">encrypt</a></li><li data-type='method'><a href="CloudParty.html#hasActor">hasActor</a></li><li data-type='method'><a href="CloudParty.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="CloudParty.html#loadActor">loadActor</a></li><li data-type='method'><a href="CloudParty.html#loadIdentity">loadIdentity</a></li><li data-type='method'><a href="CloudParty.html#socket">socket</a></li><li data-type='method'><a href="CloudParty.html#start">start</a></li></ul></li><li><a href="DataModel.html">DataModel</a><ul class='methods'><li data-type='method'><a href="DataModel.html#addFactory">addFactory</a></li><li data-type='method'><a href="DataModel.html#getDocument">getDocument</a></li><li data-type='method'><a href="DataModel.html#getFactories">getFactories</a></li><li data-type='method'><a href="DataModel.html#getFactory">getFactory</a></li><li data-type='method'><a href="DataModel.html#getTypes">getTypes</a></li><li data-type='method'><a href="DataModel.html#hydrate">hydrate</a></li><li data-type='method'><a href="DataModel.html#validate">validate</a></li></ul></li><li><a href="LocalStorageConfig.html">LocalStorageConfig</a></li><li><a href="MemoryConfig.html">MemoryConfig</a></li><li><a href="module-roshub.Api.html">Api</a><ul class='methods'><li data-type='method'><a href="module-roshub.Api.html#getLegalAgreements">getLegalAgreements</a></li></ul></li><li><a href="module-roshub.DataParty.html">DataParty</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.html#call">call</a></li><li data-type='method'><a href="module-roshub.DataParty.html#create">create</a></li><li data-type='method'><a href="module-roshub.DataParty.html#createDocument">createDocument</a></li><li data-type='method'><a href="module-roshub.DataParty.html#find">find</a></li><li data-type='method'><a href="module-roshub.DataParty.html#remove">remove</a></li><li data-type='method'><a href="module-roshub.DataParty.html#socket">socket</a></li><li data-type='method'><a href="module-roshub.DataParty.html#start">start</a></li><li data-type='method'><a href="module-roshub.DataParty.html#types">types</a></li><li data-type='method'><a href="module-roshub.DataParty.html#update">update</a></li></ul></li><li><a href="module-roshub.DataParty.Document.html">Document</a><ul class='methods'><li data-type='method'><a href="module-roshub.DataParty.Document.html#acl">acl</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#getData">getData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#grantAccess">grantAccess</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#mergeData">mergeData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#pull">pull</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#save">save</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#setData">setData</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#unwatch">unwatch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watch">watch</a></li><li data-type='method'><a href="module-roshub.DataParty.Document.html#watchField">watchField</a></li></ul></li><li><a href="module-roshub_Types.Acl.html">Acl</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Acl.html#getPermissionsByField">getPermissionsByField</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#resource">resource</a></li><li data-type='method'><a href="module-roshub_Types.Acl.html#setPermissionsByField">setPermissionsByField</a></li></ul></li><li><a href="module-roshub_Types.BillingAccount.html">BillingAccount</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreed">hasAgreed</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToMarketing">hasAgreedToMarketing</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToPrivacy">hasAgreedToPrivacy</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasAgreedToTos">hasAgreedToTos</a></li><li data-type='method'><a href="module-roshub_Types.BillingAccount.html#hasPlan">hasPlan</a></li></ul></li><li><a href="module-roshub_Types.Code.html">Code</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Code.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Code.html#addToDevice">addToDevice</a></li></ul></li><li><a href="module-roshub_Types.CodeStatus.html">CodeStatus</a></li><li><a href="module-roshub_Types.ConsoleLog.html">ConsoleLog</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.ConsoleLog.html#.create">create</a></li></ul></li><li><a href="module-roshub_Types.Device.html">Device</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Device.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#addIdentity">addIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#attachBlePeer">attachBlePeer</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#bleRun">bleRun</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#config">config</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#enroll">enroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#getCodeDocumentList">getCodeDocumentList</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#hasIdentity">hasIdentity</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#info">info</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#removeCode">removeCode</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#status">status</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topic">topic</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#topics">topics</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#unenroll">unenroll</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiConnect">wifiConnect</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiScan">wifiScan</a></li><li data-type='method'><a href="module-roshub_Types.Device.html#wifiState">wifiState</a></li></ul></li><li><a href="module-roshub_Types.DeviceConfig.html">DeviceConfig</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#addCode">addCode</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#getCodeList">getCodeList</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#module">module</a></li><li data-type='method'><a href="module-roshub_Types.DeviceConfig.html#updateModule">updateModule</a></li></ul></li><li><a href="module-roshub_Types.DeviceInfo.html">DeviceInfo</a></li><li><a href="module-roshub_Types.DeviceStatus.html">DeviceStatus</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#getProgress">getProgress</a></li><li data-type='method'><a href="module-roshub_Types.DeviceStatus.html#module">module</a></li></ul></li><li><a href="module-roshub_Types.Identity.html">Identity</a></li><li><a href="module-roshub_Types.Org.html">Org</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Org.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.Org.html#teams">teams</a></li></ul></li><li><a href="module-roshub_Types.Topic.html">Topic</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.Topic.html#.create">create</a></li><li data-type='method'><a href="module-roshub_Types.Topic.html#instance">instance</a></li></ul></li><li><a href="module-roshub_Types.User.html">User</a><ul class='methods'><li data-type='method'><a href="module-roshub_Types.User.html#billing">billing</a></li><li data-type='method'><a href="module-roshub_Types.User.html#codes">codes</a></li><li data-type='method'><a href="module-roshub_Types.User.html#devices">devices</a></li><li data-type='method'><a href="module-roshub_Types.User.html#identities">identities</a></li><li data-type='method'><a href="module-roshub_Types.User.html#orgs">orgs</a></li><li data-type='method'><a href="module-roshub_Types.User.html#teams">teams</a></li></ul></li><li><a href="NconfConfig.html">NconfConfig</a></li></ul><h3>Modules</h3><ul><li><a href="module-roshub.html">roshub</a></li><li><a href="module-roshub_Types.html">roshub/Types</a></li></ul><h3>Events</h3><ul><li><a href="module-roshub.DataParty.Document.html#event:change">change</a></li><li><a href="module-roshub.DataParty.Document.html#event:create">create</a></li><li><a href="module-roshub.DataParty.Document.html#event:field">field</a></li><li><a href="module-roshub.DataParty.Document.html#event:value">value</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-roshub.Config.html">Config</a></li></ul><h3>Global</h3><ul><li><a href="global.html#model">model</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">dataparty/cloud-party.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const debug = require('debug')('roshub.dataparty.cloudparty')

const Rest = require('../comms/rest')
const DataParty = require('./data-party')
const roshub_crypto = require('@dataparty/crypto')

/**
 * @class
 * @implements module:roshub.DataParty
 */
class CloudParty extends DataParty {

  constructor({config}){
    super({ config: config })

    this._actor = {id: undefined, type: undefined}
    this._actors = []
    this._identity = undefined
    
    //if(uri[uri.length-1] != '/'){ uri = uri+'/' }

    this.rest = new Rest({config: this.config, party: this})
  }

  /**
   * @method
   */
  hasIdentity(){
    return this._identity != undefined
  }

  /**
   * @method
   */
  hasActor(){
    return this.actor != undefined
  }

  /**
   * @type {module:roshub/Types.Identity}
   */
  get identity(){
    if (!this.hasIdentity()){ return undefined }
    return this._identity.toJSON(false)
  }

  /** @type {IdObj} */
  get actor(){
    if (this.actors &amp;&amp; this.actors[0]){

      return this.actors[0]

    } else if (this._actor.id &amp;&amp; this._actor.type){

      return this._actor

    }

    return undefined
  }

  /** @type {IdObj[]} */
  get actors(){
    return this._actors
  }

  set actors(value){
    this._actors = value

    const primaryActor = this.actor

    if (!primaryActor){
     return
    }

    this._actor.id = primaryActor.id
    this._actor.type = primaryActor.type

    const path = 'actor'
    this.config.write(path, this._actor)
  }

  /**
   * @method
   */
  async encrypt(data, to){
    const msg = new roshub_crypto.Message({msg: data})
    await msg.encrypt(this._identity, to.key)

    return msg
  }

  /**
   * @method
   */
  async decrypt(reply, expectedSender, expectClearTextReply = false){
    // if reply has ciphertext &amp; sig attempt to decrypt
    if (reply.enc &amp;&amp; reply.sig) {
      const msg = new roshub_crypto.Message(reply)

      const replyContent = await msg.decrypt(this._identity)

      const publicKeys = roshub_crypto.Routines.extractPublicKeys(msg.enc)

      debug(`publicKeys.sign - ${publicKeys.sign}`)

      if (publicKeys.sign !== expectedSender.key.public.sign ||
          publicKeys.box !== expectedSender.key.public.box) {
        throw new Error('TrustFail: reply is not from service')
      }

      debug('decrypted reply ->', JSON.stringify(replyContent))

      if (replyContent.error) {
        debug('call failed ->', replyContent.error)
        throw replyContent.error
      }

      return replyContent

    } else if (expectClearTextReply &amp;&amp; !reply.error) {

      return reply

    }

    if (reply.error) {
      debug('call failed ->', reply.error)
      throw reply.error
    }

    throw new Error('TrustFail: reply is not encrypted')
  }

  /**
   * @method
   */
  async call(msg){
    return this.rest.call('api-v2-bouncer', msg)
  }

  /**
   * @method
   */
  async socket(){
    return this.rest.websocket()
  }

  /**
   * @method
   */
  async start(){
    debug('start')
    await super.start()
    await Promise.all([
      this.loadIdentity(),
      this.loadActor(),
    ])

    await this.rest.start()
  }

  async stop(){
    await this.rest.stop()
  }

  /**
   * @method
   */
  async loadIdentity(){
    const path = 'identity'
    const cfgIdenStr = this.config.read(path)

    if (!cfgIdenStr){
      debug('generated new identity')
      this._identity = new roshub_crypto.Identity({id: 'primary'})
      await this.config.write(path, this._identity.toJSON(true))
    } else {
      debug('loaded identity')
      this._identity = roshub_crypto.Identity.fromString(JSON.stringify(cfgIdenStr))
    }
  }

  async resetIdentity(){
    const path = 'identity'
    await this.config.write(path, null)
    await this.loadIdentity()
  }

  /**
   * @method
   */
  async loadActor(){
    const path = 'actor'
    const localActorObj = this.config.read(path)

    if (!localActorObj){ return }

    this._actor.id = localActorObj.id
    this._actor.type = localActorObj.type

    debug('loaded actor', this._actor)
  }
}

module.exports = CloudParty
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Fri Sep 06 2019 14:07:23 GMT-0700 (PDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
